<link rel="stylesheet" href="/static/plugins/leaflet/leaflet.css" />
<script src="/static/plugins/leaflet/leaflet.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.js"></script>


<link rel="stylesheet" href="/static/plugins/easy-button/easy-button.css">
<script src="/static/plugins/easy-button/easy-button.js"></script> 

<link rel="stylesheet" href="/static/plugins/leaflet-locatecontrol-0.76.0/dist/L.Control.Locate.min.css" />
<script src="/static/plugins/leaflet-locatecontrol-0.76.0/dist/L.Control.Locate.min.js" charset="utf-8"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">

<script src="/static/plugins/leaflet-routing-machine-3.2.12/dist/leaflet-routing-machine.js"></script>
<link rel="stylesheet" href="/static/plugins/leaflet-routing-machine-3.2.12/dist/leaflet-routing-machine.css">

<script src="/static/plugins/control-geocoder/Control.Geocoder.js"></script>

<script src="/static/plugins/leaflet-search-3.0.2/dist/leaflet-search.min.js"></script>
<link rel="stylesheet" href="/static/plugins/leaflet-search-3.0.2/dist/leaflet-search.min.css">

<script src="/static/js/jquery-3.6.0.min.js"></script>

<div id="mapid"></div>

<link rel="stylesheet" href="/static/css/map.css">

<script>

    var map = L.map('mapid').setView([21.372538517232353, 105.5548151996359], 11.75);
    var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    mylocation = L.control.locate({
        position: 'topleft',
        strings: {
            title: "My location",
            popup: 'You are here<br><button id="useToStart">use this as start point</button><br><button id="useToEnd">use this as end point</button>',
        },
    }).addTo(map);

    //get current location 
    var myloca
    map.on('locationfound', function (self) {
    myloca = [self.latlng.lat, self.latlng.lng]
    });

    map.on('popupopen', function (self) {
        $('#useToStart').click(function () {
            control.spliceWaypoints(0, 1, myloca);
        });

        $('#useToEnd').click(function () {
            control.spliceWaypoints(1, 1, myloca);
        });
    });

    function iconLocation(feature, latlng) {
        var icontype = ""
        if(feature.typeFeature == 'Service'){
            icontype = "services-icon"
        }
        else if(feature.typeFeature == 'Place'){
            icontype = "place-icon"
        }
        else if(feature.typeFeature == 'Area'){
            icontype = "area-icon"
        }
        var iconCus = L.icon({
            iconUrl: "../../static/images/icons/" + icontype + ".png",
            iconSize: [35, 35],
            iconAnchor: [12, 41],
            popupAnchor: [5, -34],
            shadowSize: [41, 41]
        })
        return L.marker(latlng, { icon: iconCus })
    }
//     $.get('https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=47.217954&lon=-1.552918', function(data){
//     console.log(data.address.road);
// });
    //Feature 
    function choosePoint(name, num1, num2){
        $(name).click(function(){
            var a = parseFloat($(this).attr('data-lat'));
            var b = parseFloat($(this).attr('data-lng'));
            var c = [a, b];
            control.spliceWaypoints(num1, num2, c);
        })
    }

    function placeFeature(feature, layer) {
        feature.layer = layer;
        if (feature.properties) {
            layer.bindPopup("<b>Tên địa danh: </b>" + feature.properties.name + "<br>"
            + "<b>Hình ảnh: </b>" + "<img src='static/" + feature.properties.image + "' width='100px' height='100px'>" + "<br>"
            + '<button class="thisIsStartPoint" data-lat="'+ feature.geometry.coordinates[1] +'" data-lng="'+ feature.geometry.coordinates[0]+'">Use this as start point</button>' + "<br>"
            + '<button class="thisIsEndPoint" data-lat="'+ feature.geometry.coordinates[1] +'" data-lng="'+ feature.geometry.coordinates[0]+'">Use this as end point</button>' + "<br>"
            ).on("popupopen", function() {
                choosePoint('.thisIsStartPoint', 0, 1);
                choosePoint('.thisIsEndPoint', 1, 1);

            })

        }
    }

    function areaFeature(feature, layer) {
        feature.layer = layer;
        if (feature.properties) {
            layer.bindPopup("<b>Khu du lịch: </b>" + feature.properties.name + "<br>"
            + '<button class="thisIsStartPoint" data-lat="'+ feature.geometry.coordinates[1] +'" data-lng="'+ feature.geometry.coordinates[0]+'">Use this as start point</button>' + "<br>"
            + '<button class="thisIsEndPoint" data-lat="'+ feature.geometry.coordinates[1] +'" data-lng="'+ feature.geometry.coordinates[0]+'">Use this as end point</button>' + "<br>"
            ).on("popupopen", function() {
                choosePoint('.thisIsStartPoint', 0, 1);
                choosePoint('.thisIsEndPoint', 1, 1);
            })
        }
    }

    function serviceFeature(feature, layer) {
        feature.layer = layer;
        if (feature.properties) {
            layer.bindPopup("<b>Loại dịch vụ: </b>" + feature.properties.type + "<br>"
            + "<b>Tên: </b>" + feature.properties.name + "<br>"
            + "<b>Địa chỉ: </b>" + feature.properties.address + "<br>"
			+ "<b>Số điện thoại: </b>" + feature.properties.phone + "<br>"
			+ "<b>Email: </b>" + feature.properties.email + "<br>"
            + "<b>Hình ảnh: </b>" + "<img src='static/" + feature.properties.image + "' width='100px' height='100px'>" + "<br>"
            + '<button class="thisIsStartPoint" data-lat="'+ feature.geometry.coordinates[1] +'" data-lng="'+ feature.geometry.coordinates[0]+'">Use this as start point</button>' + "<br>"
            + '<button class="thisIsEndPoint" data-lat="'+ feature.geometry.coordinates[1] +'" data-lng="'+ feature.geometry.coordinates[0]+'">Use this as end point</button>' + "<br>"

            + "<a>Xem thêm</a>" + "<br>"
            ).on("popupopen", function() {
                choosePoint('.thisIsStartPoint', 0, 1);
                choosePoint('.thisIsEndPoint', 1, 1);
            })

        }
    }


    //Layer Group
    var markersLayer = new L.LayerGroup();

    // Get API tree, building
    function getAPI(link) {
        var overlay = null;
        $.ajax({
            type: "GET",
            datatype: "JSON",
            url: link,
            async: !1,
            success: function (response) {
                console.log(response)
                if (link == "/api/v1/places") {
                    overlay = L.geoJSON(response, {
                        pointToLayer: iconLocation, onEachFeature: placeFeature
                    })
                    markersLayer.addLayer(overlay)
                }
                else if (link == "/api/v1/areas") {
                    overlay = L.geoJSON(response, {
                        pointToLayer: iconLocation, onEachFeature: areaFeature
                    })
                    markersLayer.addLayer(overlay)
                }
                else if (link == "/api/v1/services") {
                    overlay = L.geoJSON(response, {
                        pointToLayer: iconLocation, onEachFeature: serviceFeature
                    })
                    markersLayer.addLayer(overlay)
                }
            }
        })
        return overlay
    }
    //layer places, areas, services
    var place = getAPI("/api/v1/places")
    var area = getAPI("/api/v1/areas")
    var service = getAPI("/api/v1/services")

    console.log(place)
    //add layer to map
    map.addLayer(markersLayer)

    // Control layers
    var baseLayers = {
        "Open Street Maps": osm
    }
    var overlays = {
        "Place": place,
        "Area": area,
        "Service": service
    }

    L.control.layers(baseLayers, overlays).addTo(map)

    //search
    var selector = L.control({
            position: 'topright'
        });

        selector.onAdd = function(map) {
            var div = L.DomUtil.create('div', 'mySelector');
            div.innerHTML = '<input id = "opt" type="text" list="marker_select" /><datalist id="marker_select"><option value="init"></option></datalist>';
            return div;
        };
    selector.addTo(map);

    var markers = markersLayer.getLayers();
    // console.log(markers)
    function markerLayer(i){
        markers[i].eachLayer(function(layer) {
            var optionElement = document.createElement("option");
            optionElement.setAttribute("data-value", layer._leaflet_id);
            optionElement.value = layer.feature.properties.name;
            L.DomUtil.get("marker_select").appendChild(optionElement);
        });
        var marker_select = L.DomUtil.get("opt");
        console.log(marker_select)
        L.DomEvent.addListener(marker_select, 'click', function(e) {
            L.DomEvent.stopPropagation(e);
        });

        L.DomEvent.addListener(marker_select, 'change', changeHandler);

        function changeHandler(e) {
            var valOption = $('option[value="'+e.target.value+'"]').data('value');
            if (e.target.value == "init") {
                map.closePopup();
            } else {
                markers[i].getLayer(valOption).openPopup();
            }
        }
    }
    for (var i = 0; i < markers.length; i++) {
        markerLayer(i);
    }

    //Control routing
    var control = L.Routing.control({
        router: L.Routing.osrmv1({
            // serviceUrl: L.osrmv1().getServiceUrl(),
            liveTraffic: true,
            profile: 'Driving',
        }),
        geocoder: L.Control.Geocoder.nominatim(),
        routeWhileDragging: true,
        reverseWaypoints: true
        })

    L.easyButton('fa-level-up',
        function () {  
            if (control._map) {
                // check = false
                map.removeControl(control)
            }
            else {
                // check = true
                map.addControl(control)
            }
        }).addTo(map);

    //map legend
    var legend = L.control({ position: 'bottomright' })
    legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'info')
        div.innerHTML += '<img style="width:30px;height:30px" src="../../static/images/icons/place-icon.png">: Place<br>'
        div.innerHTML += '<img style="width:30px;height:30px" src="../../static/images/icons/services-icon.png">: Service<br>'
        div.innerHTML += '<img style="width:30px;height:30px" src="../../static/images/icons/area-icon.png">: Area<br>'
        return div
    }
    legend.addTo(map)

    //draw Item
    drawnItems = L.featureGroup().addTo(map);
    map.addControl(new L.Control.Draw({
        edit: {
            featureGroup: drawnItems,
            poly: {
                allowIntersection: false
            }
        },
        draw: {
            polygon: false,
            circle: false,
            polyline: false,
            rectangle: false,
            circlemarker: false

        }
    }));
        // Truncate value based on number of decimals
        var _round = function(num, len) {
            return Math.round(num*(Math.pow(10, len)))/(Math.pow(10, len));
        };
        // Helper method to format LatLng object (x.xxxxxx, y.yyyyyy)
        var strLatLng = function(latlng) {
            return _round(latlng.lat, 6)+", "+_round(latlng.lng, 6);
        };

        var getPopupContent = function(layer) {
            // Marker - add lat/long
            return strLatLng(layer.getLatLng());
        };

    map.on(L.Draw.Event.CREATED, function(event) {
            var layer = event.layer;
            var content = getPopupContent(layer)+'<br><input type="checkbox" id="checkService" name="check" value="Service">'
            +'<label for="checkService">Service</label><br>'
            +'<input type="checkbox" id="checkArea" name="check" value="Area">'
            +'<label for="checkArea">Area</label><br>'
            +'<input type="checkbox" id="checkPlace" name="check" value="Place">'
            +'<label for="checkPlace">Place</label><br>'
            +'<button id="save">Save</button>';
            if (content !== null) {
                layer.bindPopup(content).on("popupopen", function() {
                    $("input:checkbox").on('click', function() {
                    var $box = $(this);
                    console.log($box.val())
                    if ($box.is(":checked")) {
                        var group = "input:checkbox[name='" + $box.attr("name") + "']";
                        console.log(group)
                        $(group).prop("checked", false);
                        $box.prop("checked", true);
                    } else {
                        $box.prop("checked", false);
                    }});

                    $("#save").click(function(){
                        var check = $("input:checkbox:checked").val()
                        function toDb(type){
                            console.log(type)
                            var lattt = layer.getLatLng()
                            console.log(lattt)
                            var geoJSON = {
                                "typeMarker": type,
                                "geometry": {
                                    "type": "Point",
                                    "coordinates": [lattt['lng'], lattt['lat']]
                                },
                            }
                            $.ajax({
                                    url: "/createNewItem",
                                    type: "POST",
                                    contentType: "application/json",
                                    data: JSON.stringify(geoJSON),
                                    success: function (data) { }
                            });
                        }
                        if (check == "Service"){
                            var geoJSON = toDb("Service")
                        }
                        else if (check == "Area"){
                            var geoJSON = toDb("Area")
                        }
                        else if (check == "Place"){
                            var geoJSON = toDb("Place")
                        }
                    })
            });
            }
            drawnItems.addLayer(layer);
        });

</script>